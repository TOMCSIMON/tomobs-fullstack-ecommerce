<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Add Product</title>

    <link rel="stylesheet" th:href="@{/css/admin-navbar.css}">
    <link rel="stylesheet" th:href="@{/css/admin-add-product.css}">
    <link th:href="@{https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css}" rel="stylesheet">
</head>

<body style="background-color:#E4E4E4">

<!-- NAVBAR -->
<div th:replace="~{fragments/admin-navbar :: adminNavbar}"></div>

<h3 class="mt-5 ms-5">Add Products</h3>

<div class="container my-4">

    <form th:action="@{/admin/products/add}" method="post" th:object="${product}" enctype="multipart/form-data">

        <!-- PRODUCT SECTION -->
        <div class="card p-3">
            <h4>Product Details</h4>

            <div class="mb-3">
                <label>Product Name</label>
                <input type="text" th:field="*{productName}" class="form-control" required>
                <div th:errors="*{productName}" class="text-danger"></div>
            </div>

            <div class="mb-3">
                <label>Brand</label>
                <select th:field="*{brandId}" class="form-control" required>
                    <option value="">-- Select Brand --</option>
                    <option th:each="b: ${brands}" th:value="${b.id}" th:text="${b.name}"></option>
                </select>
                <div th:errors="*{brandId}" class="text-danger"></div>
            </div>

            <div class="mb-3">
                <label>Category</label>
                <select th:field="*{categoryId}" class="form-control" required>
                    <option value="">-- Select Category --</option>
                    <option th:each="c: ${categories}" th:value="${c.id}" th:text="${c.name}"></option>
                </select>
                <div th:errors="*{categoryId}" class="text-danger"></div>
            </div>
        </div>

        <hr>

        <!-- VARIANT SECTION -->
        <h4>Product Variants</h4>

        <div id="variants-container">

            <!-- FIRST VARIANT  -->
            <div class="variant-block card p-3 mb-3" data-index="0">
                <h5>Variant 1</h5>

                <div class="mb-3">
                    <label>Variant Name</label>
                    <input type="text" th:field="*{variants[0].variantName}" class="form-control">
                </div>

                <div class="mb-3">
                    <label>SKU Code</label>
                    <input type="text" th:field="*{variants[0].skuCode}" class="form-control">
                </div>

                <div class="mb-3">
                    <label>RAM</label>
                    <select th:field="*{variants[0].ram}" class="form-control">
                        <option value="">Select RAM</option>
                        <option value="4 GB">4 GB</option>
                        <option value="6 GB">6 GB</option>
                        <option value="8 GB">8 GB</option>
                        <option value="12 GB">12 GB</option>
                        <option value="24 GB">24 GB</option>
                        <option value="16 GB">16 GB</option>
                        <option value="32 GB">32 GB</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label>Storage</label>
                    <select th:field="*{variants[0].storage}" class="form-control">
                        <option value="">Select Storage</option>
                        <option value="64 GB">64 GB</option>
                        <option value="128 GB">128 GB</option>
                        <option value="256 GB">256 GB</option>
                        <option value="512 GB">512 GB</option>
                        <option value="1 TB">1 TB</option>
                    </select>
                </div>


                <div class="mb-3">
                    <label>Color</label>
                    <input type="text" th:field="*{variants[0].color}" class="form-control">
                </div>

                <div class="mb-3">
                    <label>Key Features</label>
                    <textarea th:field="*{variants[0].keyFeatures}" class="form-control"></textarea>
                </div>

                <div class="mb-3">
                    <label>Price</label>
                    <input type="number" step="0.01" th:field="*{variants[0].price}" class="form-control">
                </div>

                <div class="mb-3">
                    <label>Stock</label>
                    <input type="number" th:field="*{variants[0].stock}" class="form-control">
                </div>

                <div class="mb-3">
                    <label>Variant Images</label>
                    <input type="file" th:field="*{variants[0].images}" class="form-control" multiple>
                </div>

                <button type="button" class="btn btn-danger remove-variant-btn" style="display:none;">
                    Remove Variant
                </button>
            </div>

        </div>


        <!-- TEMPLATE FOR NEW VARIANTS -->
        <template id="variant-template">
            <div class="variant-block card p-3 mb-3">
                <h5>Variant</h5>

                <div class="mb-3">
                    <label>Variant Name</label>
                    <input type="text" class="form-control" name="variants[__index__].variantName">
                </div>

                <div class="mb-3">
                    <label>SKU Code</label>
                    <input type="text" class="form-control" name="variants[__index__].skuCode">
                </div>

                <div class="mb-3">
                    <label>RAM</label>
                    <input type="text" class="form-control" name="variants[__index__].ram" >
                </div>

                <div class="mb-3">
                    <label>Storage</label>
                    <input type="text" class="form-control"  name="variants[__index__].storage" >
                </div>

                <div class="mb-3">
                    <label>Color</label>
                    <input type="text" class="form-control" name="variants[__index__].color">
                </div>

                <div class="mb-3">
                    <label>Key Features</label>
                    <textarea class="form-control" name="variants[__index__].keyFeatures"></textarea>
                </div>

                <div class="mb-3">
                    <label>Price</label>
                    <input type="number" step="0.01" class="form-control" name="variants[__index__].price">
                </div>

                <div class="mb-3">
                    <label>Stock</label>
                    <input type="number" class="form-control" name="variants[__index__].stock">
                </div>

                <div class="mb-3">
                    <label>Variant Images</label>
                    <input type="file" class="form-control" name="variants[__index__].images" multiple>
                </div>

                <button type="button" class="btn btn-danger remove-variant-btn">Remove Variant</button>
            </div>
        </template>

        <button type="button" id="add-variant-btn" class="btn btn-primary mt-2">+ Add New Variant</button>

        <hr>


        <div class="d-flex justify-content-between mb-5">
            <a th:href="@{/admin/products}" class="btn btn-danger px-4">Cancel</a>
            <button class="btn btn-success px-4">Create New Product</button>
        </div>
    </form>

</div>

<script>

    let variantIndex = 1; // First variant already exists (index 0)

    // Add new variant
    document.getElementById("add-variant-btn").addEventListener("click", function () {
        const template = document.getElementById("variant-template").innerHTML;
        const filled = template.replace(/__index__/g, variantIndex);

        const wrapper = document.createElement("div");
        wrapper.innerHTML = filled;

        document.getElementById("variants-container").appendChild(wrapper.firstElementChild);

        variantIndex++;
        updateTitles();
    });

    // Remove variant
    document.getElementById("variants-container").addEventListener("click", function (e) {
        if (e.target.classList.contains("remove-variant-btn")) {
            e.target.closest(".variant-block").remove();
            updateTitles();
        }
    });

    // Update headings
    function updateTitles() {
        document.querySelectorAll(".variant-block").forEach((block, i) => {
            block.querySelector("h5").textContent = "Variant " + (i + 1);
        });
    }

</script>

</body>
</html>
